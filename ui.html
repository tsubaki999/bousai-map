<script>
    function getWarningStyle(title) { if (!title) return { color: '#888888', level: 0, impactLevel: 0, name: '情報' }; if (title.includes('特別警報')) return { color: '#800080', level: 5, impactLevel: 10, name: '【特別警報】' }; if (title.includes('土砂災害警戒情報')) return { color: '#FF00FF', level: 4, impactLevel: 8, name: '【土砂災害警戒】' }; if (title.includes('警報')) return { color: '#FF0000', level: 3, impactLevel: 6, name: '【警報】' }; if (title.includes('注意報')) return { color: '#FFFF00', level: 2, impactLevel: 4, name: '【注意報】' }; return { color: '#888888', level: 1, impactLevel: 2, name: '早期注意情報' }; }
    function loadWeatherWarnings(warnings) { const ul = document.getElementById('warningsList'); if (!Array.isArray(warnings) || warnings.length === 0) { const li = document.createElement('li'); li.textContent = '現在、発表されている警報・注意報はありません。'; ul.appendChild(li); return; } warnings.forEach(w => { const li = document.createElement('li'); li.style.marginBottom = '8px'; const style = getWarningStyle(w.title); li.innerHTML = `<strong style="color:${style.color};">${escapeHtml(w.title)} (${(w.region||'地域不明')})</strong><br><small>${(w.time ? new Date(w.time).toLocaleString() : '時刻不明')}</small><br><small>${(w.summary||'詳細情報なし')}</small>`; ul.appendChild(li); }); }
    function addLspTextToWarnings(texts) { if (!texts || texts.length === 0) return; const ul = document.getElementById('warningsList'); texts.forEach(textInfo => { const li = document.createElement('li'); li.style.cssText = 'margin-bottom: 8px; background: #fff0f5; padding: 5px; border-left: 4px solid #FF00FF;'; li.innerHTML = `<strong style="color:#FF00FF;">【警戒レベル4相当】線状降水帯情報: ${escapeHtml(textInfo.name)}</strong><br><small>発表: ${new Date(textInfo.time).toLocaleString()}</small>`; if (ul.firstChild) ul.insertBefore(li, ul.firstChild); else ul.appendChild(li); }); }   
    function checkStoreImpacts() { const list = document.getElementById('affectedStoresList'); list.innerHTML = ''; let affectedStoresForList = []; const allCheckableStores = allStoreMarkers.concat(monogatariMarkers); const MIN_IMPACT_LEVEL_FOR_HIGHLIGHT = 6; allCheckableStores.forEach(store => { if (!store || !store.marker || !store.marker.position) return; const impacts = []; allWarningCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { impacts.push({ type: 'warning', style: circle.warningStyle }); } }); allEarthquakeCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { const distance = google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()); impacts.push({ type: 'quake', style: circle.quakeStyle, distance: distance, radius: circle.getRadius() }); } }); const markerContent = store.marker.content; if (impacts.length > 0) { impacts.sort((a, b) => b.style.impactLevel - a.style.impactLevel); const highestImpact = impacts[0]; if (highestImpact.style.impactLevel >= MIN_IMPACT_LEVEL_FOR_HIGHLIGHT) { let distance = (highestImpact.type === 'quake') ? highestImpact.distance : null; affectedStoresForList.push({ name: store.name, address: store.address || '', level: highestImpact.style.impactLevel, color: highestImpact.style.color, text: highestImpact.style.name, distance: distance, store: store }); if (markerContent) { let finalColor = highestImpact.style.color; if (highestImpact.type === 'quake' && highestImpact.style.endColor) { const factor = highestImpact.distance / highestImpact.radius; const startRgb = hexToRgb(highestImpact.style.color); const endRgb = hexToRgb(highestImpact.style.endColor); finalColor = interpolateColor(startRgb, endRgb, factor); } if (markerContent.classList.contains('pin-marker-content')) { const newLabel = document.createElement('div'); newLabel.className = 'warning-label'; newLabel.style.backgroundColor = finalColor; newLabel.style.color = highestImpact.style.textColor || ((highestImpact.style.impactLevel < 5) ? '#000' : '#fff'); newLabel.textContent = store.name; store.marker.content = newLabel; } else if (markerContent.classList.contains('warning-label')) { markerContent.style.backgroundColor = finalColor; } } } else { if (markerContent && markerContent.classList.contains('warning-label')) { store.marker.content = createPinMarkerContent(); } } } else { if (markerContent && markerContent.classList.contains('warning-label')) { store.marker.content = createPinMarkerContent(); } } }); affectedStoresForList.sort((a, b) => b.level - a.level); if (affectedStoresForList.length === 0) { list.innerHTML = '<li>現在、警戒レベル3以上の影響を受けている店舗はありません。</li>'; } else { affectedStoresForList.forEach(item => { const li = document.createElement('li'); li.style.cssText = `padding: 8px; cursor: default; border-left: 4px solid ${item.color}; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;`; let xSearchButton = ''; if (item.address) { const addressParts = item.address.match(/(([^都]*)都)?(([^府]*)府)?(([^県]*)県)?([^市]*)市([^区]*)区?(.*)/); let searchQuery = ""; if(addressParts) { const city = addressParts[7] ? addressParts[7] + "市" : ""; const ward = addressParts[9] ? addressParts[9] + "区" : ""; searchQuery = ward || city; } if (searchQuery) { const xQuery = encodeURIComponent(`${searchQuery} (停電 OR 断水 OR 冠水 OR 避難 OR 災害 OR 運転見合わせ)`); const xSearchUrl = `https://twitter.com/search?q=${xQuery}&f=live`; xSearchButton = `<a href="${xSearchUrl}" target="_blank" style="margin-left: 10px; padding: 4px 8px; background-color: #000; color: #fff; text-decoration: none; border-radius: 12px; font-size: 10px; font-weight:bold;">X</a>`; } } const distanceText = item.distance !== null ? ` (震源から約${(item.distance / 1000).toFixed(1)}km)` : ''; li.innerHTML = `<div style="flex-grow: 1; cursor: pointer;" onclick="map.setCenter({lat:${item.store.marker.position.lat},lng:${item.store.marker.position.lng}}); map.setZoom(14);"><span style="color:${item.color}; font-weight: bold;">${escapeHtml(item.text)}</span><span>${escapeHtml(item.name)}${distanceText}</span></div>${xSearchButton}`; list.appendChild(li); }); } }
    function populateFilters(data) { if(!data) return; var originSet = new Set(), destSet = new Set(); data.forEach(r => { originSet.add(r.originName); destSet.add(r.destinationName); }); var originSelect = document.getElementById('originSelect'); originSelect.innerHTML = '<option value="all">すべて</option>'; originSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; originSelect.appendChild(o); }); var destSelect = document.getElementById('destinationSelect'); destSelect.innerHTML = '<option value="all">すべて</option>'; destSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; destSelect.appendChild(o); }); }
</script>