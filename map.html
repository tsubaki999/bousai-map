<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta charset="utf-8" />
    <!-- タイトルとファビコンはサーバーサイドのdoGet関数で設定されます -->
    <meta name="referrer" content="no-referrer-when-downgrade">
    <style>
      html, body { margin: 0; padding: 0; height: 100vh; font-family: sans-serif; overflow: hidden; }
      #app-container { display: flex; flex-direction: column; height: 100%; }
      #map-wrapper { flex-grow: 1; position: relative; }
      #map { width: 100%; height: 100%; }
      #controls { position: absolute; top: 10px; left: 10px; z-index: 5; padding: 10px; background: rgba(255, 255, 255, 0.9); border-radius: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; flex-wrap: wrap; gap: 1em; align-items: center; max-width: 90%; }
      #controls fieldset { padding: 0.3em 0.6em; border: 1px solid #ccc; border-radius: 4px; display: flex; flex-wrap: wrap; gap: 0.8em; }
      #controls legend { font-size: 12px; font-weight: bold; }
      #controls label { cursor: pointer; user-select: none; }
      #radar-controls { display: flex; align-items: center; gap: 0.5em; flex-wrap: wrap; }
      #radar-controls input[type=range] { vertical-align: middle; }
      #last-updated { font-size: 10px; color: #555; width: 100%; text-align: right; margin-top: 5px; }
      select { padding: 5px; font-size: 14px; }
      #info-panels-container { flex-shrink: 0; overflow-y: auto; max-height: 40vh; background: #fff; }
      .info-panel { font-size: 14px; border-top: 1px solid #ccc; }
      .panel-header { margin: 0; padding: 10px; cursor: pointer; user-select: none; font-size: 16px; font-weight: bold; }
      .panel-header:hover { color: #007bff; }
      .panel-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
      .panel-inner-content { padding: 0 10px 10px 10px; }
      @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4); }
        70% { transform: scale(1.1); box-shadow: 0 0 5px 10px rgba(0, 0, 0, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
      }
      #legend-panel .panel-inner-content { display: flex; flex-direction: column; gap: 8px; }
      .legend-item { display: flex; align-items: flex-start; font-size: 12px; user-select: none; }
      .legend-color-box { width: 20px; height: 20px; margin-right: 8px; border: 1px solid #666; flex-shrink: 0; line-height: 20px; text-align: center; font-weight: bold; color: #333; }
      .legend-text strong { display: block; font-size: 14px; margin-bottom: 2px; }
      .warning-label {
        padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.5); animation: pulse 1.5s infinite ease-in-out;
        position: absolute; white-space: nowrap; transform: translate(-50%, -150%);
        transition: background-color 0.3s ease;
      }
       #loader-overlay {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: rgba(255, 255, 255, 0.95); z-index: 9999;
        display: flex; justify-content: center; align-items: center; flex-direction: column;
        transition: opacity 0.5s ease-out;
      }
      #loader-overlay.hidden { opacity: 0; pointer-events: none; }
      .spinner {
        border: 8px solid #f3f3f3; border-top: 8px solid #3498db;
        border-radius: 50%; width: 60px; height: 60px;
        animation: spin 1.5s linear infinite; margin-bottom: 20px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      #loader-text { font-size: 18px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <div id="loader-overlay">
      <div class="spinner"></div>
      <div id="loader-text">データを読み込んでいます...</div>
    </div>
    <div id="app-container">
      <div id="map-wrapper">
        <div id="map"></div>
        <div id="controls">
          <div style="display: none;">
            <label>出発地:<select id="originSelect"><option value="all">すべて</option></select></label>
            <label>店舗:<select id="destinationSelect"><option value="all">すべて</option></select></label>
          </div>
          <fieldset>
            <legend>表示レイヤー</legend>
            <label><input type="checkbox" id="toggleRoutes"> ルート表示</label>
            <label><input type="checkbox" id="toggleTraffic" checked> 交通状況</label>
            <label><input type="checkbox" id="toggleWarnings" checked> 気象警報</label>
            <label><input type="checkbox" id="toggleEarthquakes" > 地震情報</label>
            <label><input type="checkbox" id="toggleTyphoons" checked> 台風情報</label>
            <label><input type="checkbox" id="toggleLsp" checked> 線状降水帯</label>
            <label><input type="checkbox" id="toggleOutages" checked> 停電情報</label>
            <label><input type="checkbox" id="toggleMonogatariStores" checked> 店舗</label>
            <div id="radar-controls">
              <label><input type="checkbox" id="toggleRadar"> 雨雲レーダー</label>
              <input type="range" id="radarOpacitySlider" min="0" max="1" step="0.1" value="0.7" style="display:none;">
            </div>
            <div id="last-updated"></div>
          </fieldset>
        </div>
      </div>
     <div id="info-panels-container">
          <div id="legend-panel" class="info-panel"><h3 class="panel-header" onclick="togglePanel(this)">警戒レベル凡例 ▾</h3><div class="panel-content"><div class="panel-inner-content"><div class="legend-item"><span class="legend-color-box" style="background-color: #800080; color: white;">5</span><div class="legend-text"><strong style="color: #800080;">【特別警報】命の危険 直ちに安全確保</strong><span>取るべき行動: 警戒レベル5に相当。災害が既に発生している可能性が極めて高い状況です。</span></div></div><div class="legend-item"><span class="legend-color-box" style="background-color: #FF00FF;">4</span><div class="legend-text"><strong style="color: #FF00FF;">【土砂災害警戒, 線状降水帯】危険な場所から全員避 nạn</strong><span>取るべき行動: 避難指示に相当。危険な場所から必ず避難してください。</span></div></div><div class="legend-item"><span class="legend-color-box" style="background-color: #FF0000;">3</span><div class="legend-text"><strong style="color: #FF0000;">【警報】危険な場所から高齢者等は避難</strong><span>取るべき行動: 高齢者等避難に相当。高齢者や支援が必要な方は避難を開始してください。</span></div></div></div></div></div>
        <div id="weatherWarnings" class="info-panel"><h3 class="panel-header" onclick="togglePanel(this)">気象警報・注意報 ▾</h3><div class="panel-content"><div class="panel-inner-content"><ul id="warningsList" style="list-style:none; padding:0; margin:0;"></ul></div></div></div>
        <div id="affectedStores" class="info-panel" style="background:#fff8e1;"><h3 class="panel-header" onclick="togglePanel(this)">影響下の店舗 ▾</h3><div class="panel-content"><div class="panel-inner-content"><ul id="affectedStoresList" style="list-style:none; padding:0; margin:0;"><li>現在、影響を受けている店舗はありません。</li></ul></div></div></div>
      </div>
    </div>
    
<script>
    // グローバル変数
    var map, directionsService, infoWindow, geocoder;
    var allRoutes = [], renderedRoutes = [], animationIntervals = [], allStoreMarkers = [];
    var allWarningCircles = [], allEarthquakeCircles = [], allEarthquakeOverlays = [], allLspPolygons = [], allOutageMarkers = [], monogatariMarkers = [];
    var allTyphoonOverlays = [];
    var earthquakeAnimationIntervals = [];
    var radarUpdateInterval = null;
    var trafficLayer;

    // --- ユーティリティ関数 ---
    function escapeHtml(str) { if (typeof str !== 'string' || !str) return ''; return str.replace(/[&<>"']/g, function(match) { return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#039;'}[match]; }); }
    function togglePanel(header) { var content = header.nextElementSibling; var text = header.innerHTML; if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = '0px'; header.innerHTML = text.replace('▴', '▾'); } else { content.style.maxHeight = content.scrollHeight + "px"; header.innerHTML = text.replace('▾', '▴'); } }
    function interpolateColor(color1, color2, factor) { factor = Math.max(0, Math.min(1, factor)); const result = color1.slice(); for (let i = 0; i < 3; i++) { result[i] = Math.round(result[i] + factor * (color2[i] - result[i])); } return `rgb(${result[0]}, ${result[1]}, ${result[2]})`; }
    function hexToRgb(hex) { if(!hex || hex.length < 4) return [0,0,0]; const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return [r, g, b];}

    // --- 自動更新ロジック ---
    function clearAllRoutes() { renderedRoutes.forEach(r => r.setMap(null)); renderedRoutes = []; animationIntervals.forEach(clearInterval); animationIntervals = []; }
    function clearAllOverlays() {
        clearAllRoutes();
        allWarningCircles.forEach(c => c.setMap(null)); allWarningCircles = [];
        allEarthquakeCircles.forEach(c => c.setMap(null)); allEarthquakeCircles = [];
        allEarthquakeOverlays.forEach(o => o.setMap(null)); allEarthquakeOverlays = [];
        allTyphoonOverlays.forEach(o => o.setMap(null)); allTyphoonOverlays = [];
        earthquakeAnimationIntervals.forEach(clearInterval); earthquakeAnimationIntervals = [];
        allLspPolygons.forEach(p => p.setMap(null)); allLspPolygons = [];
        allOutageMarkers.forEach(m => m.setMap(null)); allOutageMarkers = [];
        monogatariMarkers.forEach(m => m.marker.setMap(null)); monogatariMarkers = [];
        allStoreMarkers = [];
        document.getElementById('warningsList').innerHTML = '';
        document.getElementById('affectedStoresList').innerHTML = '<li>情報を更新しています...</li>';
    }

    async function refreshAllData() {
        console.log(`[${new Date().toLocaleTimeString()}] データの更新を開始します...`);
        const loader = document.getElementById('loader-overlay');
        loader.classList.remove('hidden');
        clearAllOverlays();
        
        const [routes, warnings, quakes, outages, lspData, monogatariStores] = await Promise.all([
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getRouteMapData()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getWeatherWarningsFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getEarthquakeDataFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getPowerOutageDataFromMeraki()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getLineShapedPrecipitationFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMonogatariStores())
        ]);
        
        await fetchTyphoonData();

        console.log("基本データの取得が完了しました。");
        allRoutes = routes;
        populateFilters(routes);
        await placeMarkers();
        // drawFilteredRoutes(); // 初期表示ではルートを描画しない
        placeMonogatariMarkers(monogatariStores);
        loadWeatherWarnings(warnings);
        placeEarthquakeMarkers(quakes);
        placeMerakiOutageMarkers(outages);
        if(lspData) {
            placeLineShapedPrecipitationPolygons(lspData.polygons);
            addLspTextToWarnings(lspData.texts);
        }
        placeWarningMarkers(warnings);
        checkStoreImpacts(); // 全ての描画が終わってから影響チェック
        document.getElementById('last-updated').textContent = '最終更新: ' + new Date().toLocaleTimeString();
        console.log(`[${new Date().toLocaleTimeString()}] データの更新が完了しました。`);
        loader.classList.add('hidden');
    }

    // --- 初期化処理 ---
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center: { lat: 36.2048, lng: 138.2529 }, zoom: 6, mapId: 'd9bbe126f7dc436f2b40c092' });
      trafficLayer = new google.maps.TrafficLayer(); trafficLayer.setMap(map);
      directionsService = new google.maps.DirectionsService();
      infoWindow = new google.maps.InfoWindow();
      geocoder = new google.maps.Geocoder();
      setupLayerToggles();
      setupRadarControls();
      await refreshAllData();
      setInterval(() => {
          loader.classList.remove('hidden');
          location.reload();
      }, 5 * 60 * 1000);
    }

    // --- UI/イベント関連 ---
    function setupLayerToggles() {
      document.getElementById('originSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('destinationSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('toggleRoutes').addEventListener('change', function(e) { if (e.target.checked) { drawFilteredRoutes(); } else { clearAllRoutes(); } });
      document.getElementById('toggleTraffic').addEventListener('change', (e) => trafficLayer.setMap(e.target.checked ? map : null));
      document.getElementById('toggleWarnings').addEventListener('change', (e) => { toggleLayerVisibility(allWarningCircles, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleEarthquakes').addEventListener('change', (e) => { toggleLayerVisibility(allEarthquakeOverlays, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleTyphoons').addEventListener('change', (e) => toggleLayerVisibility(allTyphoonOverlays, e.target.checked));
      document.getElementById('toggleLsp').addEventListener('change', (e) => toggleLayerVisibility(allLspPolygons, e.target.checked));
      document.getElementById('toggleOutages').addEventListener('change', (e) => toggleLayerVisibility(allOutageMarkers, e.target.checked));
      document.getElementById('toggleMonogatariStores').addEventListener('change', (e) => toggleLayerVisibility(monogatariMarkers.map(m => m.marker), e.target.checked));
    }
    function toggleLayerVisibility(overlays, isVisible) { overlays.forEach(overlay => { if(overlay) overlay.setMap(isVisible ? map : null); }); }
    function setupRadarControls() {
        var toggle = document.getElementById('toggleRadar');
        var slider = document.getElementById('radarOpacitySlider');
        var currentRadarLayer = null;
        function removeCurrentRadarLayer() { if (currentRadarLayer) { map.overlayMapTypes.removeAt(map.overlayMapTypes.getArray().indexOf(currentRadarLayer)); currentRadarLayer = null; } }
        function updateRadar() {
            var date = new Date(); var minutes = date.getMinutes();
            var roundedMinutes = Math.floor(minutes / 5) * 5;
            date.setMinutes(roundedMinutes, 0, 0);
            var year = date.getUTCFullYear(), month = ('0' + (date.getUTCMonth() + 1)).slice(-2), day = ('0' + date.getUTCDate()).slice(-2), hours = ('0' + date.getUTCHours()).slice(-2), mins = ('0' + date.getUTCMinutes()).slice(-2);
            var timestamp = "" + year + month + day + hours + mins + "00";
            removeCurrentRadarLayer();
            var opacity = parseFloat(slider.value);
            currentRadarLayer = new google.maps.ImageMapType({ getTileUrl: (c, z) => { if (z < 3 || z > 14) return null; return "https://www.jma.go.jp/bosai/jmatile/data/nowc/"+timestamp+"/none/"+timestamp+"/surf/hrpns/"+z+"/"+c.x+"/"+c.y+".png"; }, tileSize: new google.maps.Size(256, 256), isPng: true, name: "Rain Radar", opacity: opacity, minZoom: 3, maxZoom: 14});
            map.overlayMapTypes.push(currentRadarLayer);
        }
        toggle.addEventListener('change', function() {
            if (this.checked) {
                slider.style.display = 'inline-block'; updateRadar();
                if (!radarUpdateInterval) { radarUpdateInterval = setInterval(updateRadar, 5 * 60 * 1000); }
            } else {
                slider.style.display = 'none'; removeCurrentRadarLayer();
                if (radarUpdateInterval) { clearInterval(radarUpdateInterval); radarUpdateInterval = null; }
            }
        });
        slider.addEventListener('input', () => { if (currentRadarLayer) currentRadarLayer.setOpacity(parseFloat(slider.value)); });
    }
    function populateFilters(data) { if(!data) return; var originSet = new Set(), destSet = new Set(); data.forEach(r => { originSet.add(r.originName); destSet.add(r.destinationName); }); var originSelect = document.getElementById('originSelect'); originSelect.innerHTML = '<option value="all">すべて</option>'; originSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; originSelect.appendChild(o); }); var destSelect = document.getElementById('destinationSelect'); destSelect.innerHTML = '<option value="all">すべて</option>'; destSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; destSelect.appendChild(o); }); }
    function loadWeatherWarnings(warnings) { const ul = document.getElementById('warningsList'); if (!Array.isArray(warnings) || warnings.length === 0) { const li = document.createElement('li'); li.textContent = '現在、発表されている警報・注意報はありません。'; ul.appendChild(li); return; } warnings.forEach(w => { const li = document.createElement('li'); li.style.marginBottom = '8px'; const style = getWarningStyle(w.title); li.innerHTML = '<strong style="color:' + style.color + ';">' + escapeHtml(w.title) + ' (' + (w.region||'地域不明') + ')</strong><br><small>' + (w.time ? new Date(w.time).toLocaleString() : '時刻不明') + '</small><br><small>' + (w.summary||'詳細情報なし') + '</small>'; ul.appendChild(li); }); }
    function addLspTextToWarnings(texts) { if (!texts || texts.length === 0) return; const ul = document.getElementById('warningsList'); texts.forEach(textInfo => { const li = document.createElement('li'); li.style.cssText = 'margin-bottom: 8px; background: #fff0f5; padding: 5px; border-left: 4px solid #FF00FF;'; li.innerHTML = '<strong style="color:#FF00FF;">【警戒レベル4相当】線状降水帯情報: ' + escapeHtml(textInfo.name) + '</strong><br><small>発表: ' + new Date(textInfo.time).toLocaleString() + '</small>'; if (ul.firstChild) ul.insertBefore(li, ul.firstChild); else ul.appendChild(li); }); }   

    // --- 描画関連 ---
    function createPinMarkerContent() {
        var markerContent = document.createElement('div'); markerContent.style.cursor = 'pointer'; markerContent.className = 'pin-marker-content';
        var pinContainer = document.createElement('div'); pinContainer.style.cssText = 'position: relative; width: 28px; height: 40px; transform: translate(-50%, -100%);';
        var pinBody = document.createElement('div'); pinBody.style.cssText = 'position: absolute; left: 0; top: 0; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; background: #EA4335; transform: rotate(-45deg); border: 1px solid #C62828;';
        pinContainer.appendChild(pinBody);
        var pinHead = document.createElement('div'); pinHead.style.cssText = 'position: absolute; left: 7px; top: 7px; width: 14px; height: 14px; border-radius: 50%; background: white;';
        pinContainer.appendChild(pinHead);
        markerContent.appendChild(pinContainer);
        return markerContent;
    }
    function placeMonogatariMarkers(stores) {
        if (!stores || stores.length === 0) { return; }
        monogatariMarkers.forEach(m => m.marker.setMap(null));
        monogatariMarkers = [];
        stores.forEach(store => {
            const lat = parseFloat(store.lat), lng = parseFloat(store.lng);
            if (!isNaN(lat) && !isNaN(lng)) {
                const position = { lat, lng };
                var marker = new google.maps.marker.AdvancedMarkerElement({ map: map, position: position, content: createPinMarkerContent(), title: store.name });
                monogatariMarkers.push({ marker: marker, name: store.name, address: store.address });
                marker.addListener("gmp-click", () => {
                    var content = '<div style="font-family: sans-serif; font-size: 14px; max-width: 280px;"><strong style="font-size: 16px;">' + escapeHtml(store.name) + '</strong><br><strong>住所:</strong> ' + escapeHtml(store.address) + '<br><a href="https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(store.address) + '" target="_blank">Googleマップで見る</a></div>';
                    infoWindow.setContent(content); infoWindow.open({ anchor: marker, map: map });
                });
            }
        });
        toggleLayerVisibility(monogatariMarkers.map(m => m.marker), document.getElementById('toggleMonogatariStores').checked);
    }
    function placeMarkers() { return new Promise(resolve => { const locationMap = new Map(); if(allRoutes) allRoutes.forEach(route => { if (!locationMap.has(route.origin)) locationMap.set(route.origin, { name: route.originName, type: "base" }); if (route.waypoints) route.waypoints.forEach(w => { if (!locationMap.has(w.address)) locationMap.set(w.address, { name: w.name, type: "store" }); }); if (!locationMap.has(route.destination)) locationMap.set(route.destination, { name: route.destinationName, type: "store" }); }); if (locationMap.size === 0) return resolve(); const geocodingPromises = Array.from(locationMap.entries()).map(([address, info]) => { return new Promise(pResolve => { geocoder.geocode({ address }, (results, status) => { if (status === 'OK' && results[0] && info.type === 'store') { allStoreMarkers.push({ marker: { position: results[0].geometry.location, content: null }, name: info.name, address: address }); } pResolve(); }); }); }); Promise.all(geocodingPromises).then(resolve); }); }   
    function placeWarningMarkers(warnings) { if (!warnings || warnings.length === 0) { return; } warnings.forEach(w => { const lat = parseFloat(w.lat), lng = parseFloat(w.lng); if (isNaN(lat) || isNaN(lng)) return; const style = getWarningStyle(w.title); const circle = new google.maps.Circle({ map: map, center: { lat, lng }, radius: 20000, fillColor: style.color, fillOpacity: 0.25, strokeColor: style.color, strokeOpacity: 0.5, strokeWeight: 1 }); circle.warningStyle = style; allWarningCircles.push(circle); const infoContent = '<strong style="color:' + style.color + ';">' + escapeHtml(w.title) + '</strong><br>' + '<strong>地域:</strong> ' + escapeHtml(w.region) + '<br>' + '<strong>内容:</strong> ' + escapeHtml(w.summary) + '<br>' + '<a href="' + escapeHtml(w.link) + '" target="_blank">詳細(気象庁)</a><br>' + '<strong>発表:</strong> ' + new Date(w.time).toLocaleString(); circle.addListener('click', () => {infoWindow.setContent(infoContent); infoWindow.setPosition({ lat, lng }); infoWindow.open(map);}); }); toggleLayerVisibility(allWarningCircles, document.getElementById('toggleWarnings').checked); }
    function createEarthquakeMarkerContent(intensity) { const style = getEarthquakeStyle(intensity); const intensityText = convertIntensityToString(intensity); const container = document.createElement('div'); container.style.position = 'relative'; container.style.width = '40px'; container.style.height = '40px'; const rippleEl = document.createElement('div'); rippleEl.style.cssText = `position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border-radius: 50%; background-color: ${style.color}; transform: translate(-50%, -50%); animation: ripple 1.5s infinite ease-out;`; const markerEl = document.createElement('div'); markerEl.style.cssText = `position: absolute; top: 50%; left: 50%; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background-color: ${style.color}; color: ${style.textColor}; font-size: 14px; font-weight: bold; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.5); cursor: pointer; transform: translate(-50%, -50%);`; markerEl.textContent = intensityText; container.appendChild(rippleEl); container.appendChild(markerEl); if (!document.getElementById('earthquake-ripple-style')) { const styleSheet = document.createElement("style"); styleSheet.id = 'earthquake-ripple-style'; styleSheet.type = "text/css"; styleSheet.innerText = `@keyframes ripple { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }`; document.head.appendChild(styleSheet); } return container; }
    function placeEarthquakeMarkers(quakes) { if (!quakes || quakes.length === 0) return; quakes.forEach(q => { const lat = parseFloat(q.lat), lng = parseFloat(q.lng); if (isNaN(lat) || isNaN(lng)) return; const position = { lat, lng }; const intensity = parseFloat(q.maxIntensity); const style = getEarthquakeStyle(intensity); const circle = new google.maps.Circle({ strokeColor: style.color, strokeOpacity: 0.5, strokeWeight: 1, fillColor: style.color, fillOpacity: 0.2, map: map, center: position, radius: style.scale * 15000, zIndex: 99 }); circle.quakeStyle = style; allEarthquakeCircles.push(circle); const marker = new google.maps.marker.AdvancedMarkerElement({ position, map, content: createEarthquakeMarkerContent(intensity), title: q.title, zIndex: 100 }); allEarthquakeOverlays.push(circle, marker); const infoContent = '<strong>' + escapeHtml(q.title) + '</strong><br>' + '最大震度: ' + convertIntensityToString(intensity) + '<br>' + escapeHtml(q.content) + '<br>' + '<a href="' + escapeHtml(q.detailLink) + '" target="_blank">詳細情報</a>'; marker.addListener('gmp-click', () => { infoWindow.setContent(infoContent); infoWindow.open({ anchor: marker, map: map }); }); circle.addListener('click', () => { infoWindow.setContent(infoContent); infoWindow.setPosition(position); infoWindow.open(map); }); }); toggleLayerVisibility(allEarthquakeOverlays, document.getElementById('toggleEarthquakes').checked); }
    function placeLineShapedPrecipitationPolygons(polygons) { if (!polygons || polygons.length === 0) return; polygons.forEach(area => { const polygonPath = area.coordinates[0].map(coord => ({ lat: coord[1], lng: coord[0] })); const lspPolygon = new google.maps.Polygon({ paths: polygonPath, strokeColor: "#FF00FF", strokeOpacity: 0.8, strokeWeight: 2, fillColor: "#FF00FF", fillOpacity: 0.35, map: map, zIndex: 90 }); allLspPolygons.push(lspPolygon); const infoContent = `<strong style="color:#FF00FF;">【警戒レベル4相当】線状降水帯発生情報</span></strong><br><strong>エリア:</strong> ${escapeHtml(area.name)}<br><strong>発表時刻:</strong> ${new Date(area.time).toLocaleString()}`; lspPolygon.addListener('click', event => { infoWindow.setContent(infoContent); infoWindow.setPosition(event.latLng); infoWindow.open(map); }); }); toggleLayerVisibility(allLspPolygons, document.getElementById('toggleLsp').checked); }
    function placeMerakiOutageMarkers(outages) { if (!outages || outages.length === 0) return; const iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><defs><filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="12" cy="12" r="10" fill="#212121"/><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="#D32F2F" stroke="#F44336" stroke-width="0.5" style="filter:url(#glow)"/></svg>'; outages.forEach(o => { const lat = parseFloat(o.lat), lng = parseFloat(o.lng); if(isNaN(lat) || isNaN(lng)) return; const markerContent = document.createElement('div'); markerContent.innerHTML = iconSvg; markerContent.style.cursor = 'pointer'; const marker = new google.maps.marker.AdvancedMarkerElement({ map, position: { lat, lng }, content: markerContent, title: o.storeName + ' (スイッチDOWN)' }); allOutageMarkers.push(marker); marker.addListener('gmp-click', () => { const content = `<div style="font-family: sans-serif; font-size: 14px; max-width: 280px;"><strong style="font-size: 16px; color: #D32F2F;">🚨 MerakiスイッチDOWN (停電の可能性)</strong><br><strong>店舗名:</strong> ${escapeHtml(o.storeName)}<br><strong>住所:</strong> ${escapeHtml(o.address)}<br><strong>最終確認時刻:</strong> ${(o.lastSeen ? new Date(o.lastSeen).toLocaleString() : '不明')}<br><small style="color: #757575;">この情報はMerakiネットワーク機器の疎通断を検知したものです。</small></div>`; infoWindow.setContent(content); infoWindow.open({ anchor: marker, map }); }); }); toggleLayerVisibility(allOutageMarkers, document.getElementById('toggleOutages').checked); }
    function drawFilteredRoutes() { if(!allRoutes) return; clearAllRoutes(); var filtered = allRoutes; let delay = 0; filtered.forEach(route => { setTimeout(() => { var waypointsForRequest = (route.waypoints || []).map(w => ({ location: w.address, stopover: true })); directionsService.route({ origin: route.origin, destination: route.destination, waypoints: waypointsForRequest, travelMode: 'DRIVING', drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }}, (result, status) => { if (status === 'OK') drawAnimatedRoute(result, route); else console.error('ルート取得失敗:', status, '対象:', route.originName + ' -> ' + route.destinationName); }); }, delay); delay += 100; }); }
    function drawAnimatedRoute(directionsResult, routeInfo) { var route = directionsResult.routes[0], totalDistance = 0, totalDuration = 0; route.legs.forEach(leg => { totalDistance += leg.distance.value; totalDuration += (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value); }); var waypointsDisplay = routeInfo.waypoints && routeInfo.waypoints.length > 0 ? '<strong>経由地:</strong> ' + routeInfo.waypoints.map(wp => escapeHtml(wp.name)).join(' → ') + '<br>' : ''; var tooltipContent = '<div style="font-family: sans-serif; font-size: 14px; max-width: 300px; line-height: 1.6;"><strong style="font-size: 16px; color: #007bff;">ルート詳細</strong><hr style="margin: 4px 0;"><strong>出発地:</strong> ' + escapeHtml(routeInfo.originName) + '<br>' + waypointsDisplay + '<strong>目的地:</strong> ' + escapeHtml(routeInfo.destinationName) + '<hr style="margin: 4px 0;"><strong>総距離:</strong> ' + (totalDistance / 1000).toFixed(1) + ' km<br>' + '<strong>予測所要時間:</strong> ' + Math.round(totalDuration / 60) + ' 分</div>'; var basePolyline = new google.maps.Polyline({ path: route.overview_path, strokeColor: '#0099ff', strokeOpacity: 0.3, strokeWeight: 8, map: map }); var animatedPolyline = new google.maps.Polyline({ path: route.overview_path, strokeOpacity: 0, icons: [{ icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 3, fillColor: '#FF0000', fillOpacity: 0.8, strokeWeight: 1 }, offset: '0%' }], map: map }); basePolyline.addListener('click', e => { infoWindow.setContent(tooltipContent); infoWindow.setPosition(e.latLng); infoWindow.open(map); }); basePolyline.addListener('mouseover', () => { map.getDiv().style.cursor = 'pointer'; }); basePolyline.addListener('mouseout', () => { map.getDiv().style.cursor = ''; }); renderedRoutes.push(basePolyline, animatedPolyline); var count = 0; var interval = setInterval(() => { count = (count + 1) % 200; var icons = animatedPolyline.get('icons'); icons[0].offset = (count / 2) + '%'; animatedPolyline.set('icons', icons); }, 50); animationIntervals.push(interval); }
    
    // --- Impact Analysis ---
    function checkStoreImpacts() { const list = document.getElementById('affectedStoresList'); list.innerHTML = ''; let affectedStoresForList = []; const allCheckableStores = allStoreMarkers.concat(monogatariMarkers); const MIN_IMPACT_LEVEL_FOR_HIGHLIGHT = 6; allCheckableStores.forEach(store => { if (!store || !store.marker || !store.marker.position) return; const impacts = []; allWarningCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { impacts.push({ type: 'warning', style: circle.warningStyle }); } }); allEarthquakeCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { const distance = google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()); impacts.push({ type: 'quake', style: circle.quakeStyle, distance: distance, radius: circle.getRadius() }); } }); const markerContent = store.marker.content; if (impacts.length > 0) { impacts.sort((a, b) => b.style.impactLevel - a.style.impactLevel); const highestImpact = impacts[0]; if (highestImpact.style.impactLevel >= MIN_IMPACT_LEVEL_FOR_HIGHLIGHT) { let distance = (highestImpact.type === 'quake') ? highestImpact.distance : null; affectedStoresForList.push({ name: store.name, address: store.address || '', level: highestImpact.style.impactLevel, color: highestImpact.style.color, text: highestImpact.style.name, distance: distance, store: store }); if (markerContent) { let finalColor = highestImpact.style.color; if (highestImpact.type === 'quake' && highestImpact.style.endColor) { const factor = highestImpact.distance / highestImpact.radius; const startRgb = hexToRgb(highestImpact.style.color); const endRgb = hexToRgb(highestImpact.style.endColor); finalColor = interpolateColor(startRgb, endRgb, factor); } if (markerContent.classList.contains('pin-marker-content')) { const newLabel = document.createElement('div'); newLabel.className = 'warning-label'; newLabel.style.backgroundColor = finalColor; newLabel.style.color = highestImpact.style.textColor || ((highestImpact.style.impactLevel < 5) ? '#000' : '#fff'); newLabel.textContent = store.name; store.marker.content = newLabel; } else if (markerContent.classList.contains('warning-label')) { markerContent.style.backgroundColor = finalColor; } } } else { if (markerContent && markerContent.classList.contains('warning-label')) { store.marker.content = createPinMarkerContent(); } } } else { if (markerContent && markerContent.classList.contains('warning-label')) { store.marker.content = createPinMarkerContent(); } } }); affectedStoresForList.sort((a, b) => b.level - a.level); if (affectedStoresForList.length === 0) { list.innerHTML = '<li>現在、警戒レベル3以上の影響を受けている店舗はありません。</li>'; } else { affectedStoresForList.forEach(item => { const li = document.createElement('li'); li.style.cssText = `padding: 8px; cursor: default; border-left: 4px solid ${item.color}; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;`; let xSearchButton = ''; if (item.address) { const addressParts = item.address.match(/(([^都]*)都)?(([^府]*)府)?(([^県]*)県)?([^市]*)市([^区]*)区?(.*)/); let searchQuery = ""; if(addressParts) { const city = addressParts[7] ? addressParts[7] + "市" : ""; const ward = addressParts[9] ? addressParts[9] + "区" : ""; searchQuery = ward || city; } if (searchQuery) { const xQuery = encodeURIComponent(`${searchQuery} (停電 OR 断水 OR 冠水 OR 避難 OR 災害 OR 運転見合わせ)`); const xSearchUrl = `https://twitter.com/search?q=${xQuery}&f=live`; xSearchButton = `<a href="${xSearchUrl}" target="_blank" style="margin-left: 10px; padding: 4px 8px; background-color: #000; color: #fff; text-decoration: none; border-radius: 12px; font-size: 10px; font-weight:bold;">X</a>`; } } const distanceText = item.distance !== null ? ` (震源から約${(item.distance / 1000).toFixed(1)}km)` : ''; li.innerHTML = `<div style="flex-grow: 1; cursor: pointer;" onclick="map.setCenter({lat:${item.store.marker.position.lat},lng:${item.store.marker.position.lng}}); map.setZoom(14);"><span style="color:${item.color}; font-weight: bold;">${escapeHtml(item.text)}</span><span>${escapeHtml(item.name)}${distanceText}</span></div>${xSearchButton}`; list.appendChild(li); }); } }
    
    // --- Typhoon Functions (Client-side) ---
    async function fetchTyphoonData() { /* ... */ }
    function parseTyphoonPoint(pointData, type) { /* ... */ }
    function generateIsewanTyphoonDummyData() { /* ... */ }
    function placeTyphoonForecast(typhoonData) { /* ... */ }

    // Google Maps APIの読み込み
    google.script.run.withSuccessHandler(function(apiKey) {
      var script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&libraries=marker,geometry,places&callback=initMap';
      script.async = true;
      document.head.appendChild(script);
    }).getApiKey();
</script>
</body>
</html>