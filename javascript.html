<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    var map, directionsService, infoWindow, geocoder;
    var allRoutes = [], renderedRoutes = [], animationIntervals = [], allStoreMarkers = [];
    var allWarningCircles = [], allEarthquakeCircles = [], allEarthquakeOverlays = [], allLspPolygons = [], allOutageMarkers = [], monogatariMarkers = [];
    var radarUpdateInterval = null;
    var trafficLayer;

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
    function escapeHtml(str) {
      if (typeof str !== 'string' || !str) return '';
      return str.replace(/[&<>"']/g, function(match) { return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#039;'}[match]; });
    }
    function togglePanel(header) {
      var content = header.nextElementSibling;
      var text = header.innerHTML;
      if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        content.style.maxHeight = '0px';
        header.innerHTML = text.replace('â–´', 'â–¾');
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
        header.innerHTML = text.replace('â–¾', 'â–´');
      }
    }

    // --- è‡ªå‹•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ ---
    function clearAllOverlays() {
        clearAllRoutes();
        renderedRoutes.forEach(r => r.setMap(null));
        renderedRoutes = [];
        animationIntervals.forEach(clearInterval);
        animationIntervals = [];
        allWarningCircles.forEach(c => c.setMap(null));
        allWarningCircles = [];
        allEarthquakeCircles.forEach(c => c.setMap(null));
        allEarthquakeCircles = [];
        allEarthquakeOverlays.forEach(o => o.setMap(null));
        allEarthquakeOverlays = [];
        allLspPolygons.forEach(p => p.setMap(null));
        allLspPolygons = [];
        allOutageMarkers.forEach(m => m.setMap(null));
        allOutageMarkers = [];
        monogatariMarkers.forEach(m => m.marker.setMap(null));
        monogatariMarkers = [];
        allStoreMarkers = [];
        document.getElementById('warningsList').innerHTML = '';
        document.getElementById('affectedStoresList').innerHTML = '<li>æƒ…å ±ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™...</li>';
    }

    function clearAllRoutes() {
        renderedRoutes.forEach(r => r.setMap(null));
        renderedRoutes = [];
        animationIntervals.forEach(clearInterval);
        animationIntervals = [];
    }

    async function refreshAllData() {
        console.log(`[${new Date().toLocaleTimeString()}] ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã™...`);
        const loader = document.getElementById('loader-overlay');
        loader.classList.remove('hidden');
        clearAllOverlays();
        
        // â˜…â˜…â˜… ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ä¸€æœ¬åŒ– â˜…â˜…â˜…
        const [routes, affectedStores, monogatariStores, outages] = await Promise.all([
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getRouteMapData()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStoreImpacts()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMonogatariStores()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getPowerOutageDataFromMeraki())
        ]);
        
        // å°é¢¨ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§å–å¾—
        await fetchTyphoonData();

        console.log("ãƒªã‚¹ã‚¯è©•ä¾¡çµæœã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚");
        allRoutes = routes;

        // --- æç”»å‡¦ç† ---
        populateFilters(routes);
        placeMonogatariMarkers(monogatariStores);     // 1. å…¨åº—èˆ—ã‚’ãƒ”ãƒ³ã§æç”»
        placeAffectedStoreMarkers(affectedStores);      // 2. ãƒªã‚¹ã‚¯ã®ã‚ã‚‹åº—èˆ—ã«ã‚¹ã‚³ã‚¢ãƒãƒ¼ã‚«ãƒ¼ã‚’é‡ã­ã¦æç”» & ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        placeMerakiOutageMarkers(outages);            // 3. åœé›»æƒ…å ±ã‚’æç”»
        
        // â˜…â˜…â˜… ä¸è¦ã«ãªã£ãŸé–¢æ•°ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ â˜…â˜…â˜…
        // loadWeatherWarnings(warnings); 
        // placeWarningMarkers(warnings);
        // placeEarthquakeMarkers(quakes);
        // updatePrefectureHighlight(...);
        
        document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleTimeString();
        console.log(`[${new Date().toLocaleTimeString()}] ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
        loader.classList.add('hidden');
    }

    // --- åˆæœŸåŒ–å‡¦ç† ---
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 36.2048, lng: 138.2529 }, zoom: 6,
          mapId: 'd9bbe126f7dc436f2b40c092'
      });
      trafficLayer = new google.maps.TrafficLayer();
      trafficLayer.setMap(map);
      directionsService = new google.maps.DirectionsService();
      infoWindow = new google.maps.InfoWindow();
      geocoder = new google.maps.Geocoder();
      setupLayerToggles();
      setupRadarControls();
      await refreshAllData();
      setInterval(refreshAllData, 5 * 60 * 1000);
    }

    // â˜…â˜…â˜… GeoJSONã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰éåŒæœŸã§å–å¾—ã—ã¦åœ°å›³ã«ãƒ­ãƒ¼ãƒ‰ â˜…â˜…â˜…
    google.script.run.withSuccessHandler(function(geojson) {
        if (geojson) {
            map.data.addGeoJson(geojson);
        } else {
            console.error("GeoJSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    }).getGeoJson();

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    function setupLayerToggles() {
      document.getElementById('originSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('destinationSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('toggleTraffic').addEventListener('change', function(e) { trafficLayer.setMap(e.target.checked ? map : null); });
      document.getElementById('toggleWarnings').addEventListener('change', function(e) { toggleLayerVisibility(allWarningCircles, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleEarthquakes').addEventListener('change', function(e) { toggleLayerVisibility(allEarthquakeOverlays, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleLsp').addEventListener('change', function(e) { toggleLayerVisibility(allLspPolygons, e.target.checked); });
      document.getElementById('toggleOutages').addEventListener('change', function(e) { toggleLayerVisibility(allOutageMarkers, e.target.checked); });
      document.getElementById('toggleStores').addEventListener('change', function(e) {
          var markers = monogatariMarkers.map(function(m) { return m.marker; });
          toggleLayerVisibility(markers, e.target.checked);
      });
      document.getElementById('toggleRoutes').addEventListener('change', function(e) {
        if (e.target.checked) {
            drawFilteredRoutes(); 
        } else {
            clearAllRoutes(); // ãƒã‚§ãƒƒã‚¯ãŒå¤–ã‚ŒãŸã‚‰ã€æ–°ã—ã„ã‚¯ãƒªã‚¢é–¢æ•°ã‚’å‘¼ã¶ã ã‘
        }
      });
    }

    // --- è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£ã®é–¢æ•° ---
    function toggleLayerVisibility(overlays, isVisible) {
      var targetMap = isVisible ? map : null;
      overlays.forEach(function(overlay) { if(overlay) overlay.setMap(targetMap); });
    }

    function setupRadarControls() {
        var toggle = document.getElementById('toggleRadar');
        var slider = document.getElementById('radarOpacitySlider');
        var currentRadarLayer = null;
        function removeCurrentRadarLayer() { if (currentRadarLayer) { map.overlayMapTypes.removeAt(map.overlayMapTypes.getArray().indexOf(currentRadarLayer)); currentRadarLayer = null; } }
        function updateRadar() {
            var date = new Date();
            var minutes = date.getMinutes();
            var roundedMinutes = Math.floor(minutes / 5) * 5;
            date.setMinutes(roundedMinutes, 0, 0);
            var year = date.getUTCFullYear(), month = ('0' + (date.getUTCMonth() + 1)).slice(-2), day = ('0' + date.getUTCDate()).slice(-2), hours = ('0' + date.getUTCHours()).slice(-2), mins = ('0' + date.getUTCMinutes()).slice(-2);
            var timestamp = "" + year + month + day + hours + mins + "00";
            removeCurrentRadarLayer();
            var opacity = parseFloat(slider.value);
            currentRadarLayer = new google.maps.ImageMapType({ getTileUrl: function(c, z) { if (z < 3 || z > 11) return null; return "https://www.jma.go.jp/bosai/jmatile/data/nowc/"+timestamp+"/none/"+timestamp+"/surf/hrpns/"+z+"/"+c.x+"/"+c.y+".png"; }, tileSize: new google.maps.Size(256, 256), isPng: true, name: "Rain Radar", opacity: opacity, minZoom: 3, maxZoom: 11 });
            map.overlayMapTypes.push(currentRadarLayer);
        }
        toggle.addEventListener('change', function() {
            if (this.checked) {
                slider.style.display = 'inline-block'; updateRadar();
                if (!radarUpdateInterval) { radarUpdateInterval = setInterval(updateRadar, 5 * 60 * 1000); }
            } else {
                slider.style.display = 'none'; removeCurrentRadarLayer();
                if (radarUpdateInterval) { clearInterval(radarUpdateInterval); radarUpdateInterval = null; }
            }
        });
        slider.addEventListener('input', function() { if (currentRadarLayer) currentRadarLayer.setOpacity(parseFloat(this.value)); });
    }

    // --- ãƒãƒ¼ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
    function createPinMarkerContent() {
        var markerContent = document.createElement('div');
        markerContent.style.cursor = 'pointer';
        markerContent.className = 'pin-marker-content';
        var pinContainer = document.createElement('div');
        pinContainer.style.cssText = 'position: relative; width: 28px; height: 40px; transform: translate(-50%, -100%);';
        var pinBody = document.createElement('div');
        pinBody.style.cssText = 'position: absolute; left: 0; top: 0; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; background: #EA4335; transform: rotate(-45deg); border: 1px solid #C62828;';
        pinContainer.appendChild(pinBody);
        var pinHead = document.createElement('div');
        pinHead.style.cssText = 'position: absolute; left: 7px; top: 7px; width: 14px; height: 14px; border-radius: 50%; background: white;';
        pinContainer.appendChild(pinHead);
        markerContent.appendChild(pinContainer);
        return markerContent;
    }

    // â˜…â˜…â˜… ã“ã®é–¢æ•°ã‚’ placeMonogatariMarkers ã®å‰ã«è¿½åŠ  â˜…â˜…â˜…
    function createPinMarkerElement() {
        var markerContent = document.createElement('div');
        markerContent.style.cursor = 'pointer';
        markerContent.className = 'pin-marker-content';
        var pinContainer = document.createElement('div');
        pinContainer.style.cssText = 'position: relative; width: 28px; height: 40px; transform: translate(-50%, -100%);';
        var pinBody = document.createElement('div');
        pinBody.style.cssText = 'position: absolute; left: 0; top: 0; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; background: #EA4335; transform: rotate(-45deg); border: 1px solid #C62828;';
        pinContainer.appendChild(pinBody);
        var pinHead = document.createElement('div');
        pinHead.style.cssText = 'position: absolute; left: 7px; top: 7px; width: 14px; height: 14px; border-radius: 50%; background: white;';
        pinContainer.appendChild(pinHead);
        markerContent.appendChild(pinContainer);
        return markerContent;
    }

    // --- ç‰©èªã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åº—èˆ—ãƒãƒ¼ã‚«ãƒ¼è¨­ç½® ---
    function placeMonogatariMarkers(stores) {
        if (!stores || stores.length === 0) { console.log("åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
        monogatariMarkers.forEach(m => m.marker.setMap(null));
        monogatariMarkers = [];
        stores.forEach(store => {
            const lat = parseFloat(store.lat);
            const lng = parseFloat(store.lng);
            if (!isNaN(lat) && !isNaN(lng)) {
                const position = { lat: lat, lng: lng };
                var marker = new google.maps.marker.AdvancedMarkerElement({ map: map, position: position, content: createPinMarkerElement(), title: store.name });
                monogatariMarkers.push({ marker: marker, name: store.name, address: store.address });
                
                marker.addListener("gmp-click", () => {
                    var content = '<div style="font-family: sans-serif; font-size: 14px; max-width: 280px;"><strong style="font-size: 16px;">' + escapeHtml(store.name) + '</strong><br><strong>ä½æ‰€:</strong> ' + escapeHtml(store.address) + '<br><a href="https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(store.address) + '" target="_blank">Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹</a></div>';
                    infoWindow.setContent(content);
                    infoWindow.open({ anchor: marker, map: map });
                });
            } else { 
                console.warn('ç„¡åŠ¹ãªåº§æ¨™ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿: ' + store.name); 
            }
        });

        // â˜…â˜…â˜… ä¿®æ­£ç‚¹: IDã‚’ 'toggleMonogatariStores' ã‹ã‚‰ 'toggleStores' ã«å¤‰æ›´ â˜…â˜…â˜…
        const initialVisibility = document.getElementById('toggleStores').checked;
        const markers = monogatariMarkers.map(m => m.marker);
        toggleLayerVisibility(markers, initialVisibility);
    }

    // --- ç½å®³æƒ…å ±ã€é…é€ãƒ«ãƒ¼ãƒˆã€ãã®ä»–ãƒãƒ¼ã‚«ãƒ¼ã®è¨­ç½® ---
    function getWarningStyle(title) {
        if (!title) return { color: '#888888', level: 0, impactLevel: 0, name: 'æƒ…å ±' };
        if (title.includes('ç‰¹åˆ¥è­¦å ±')) return { color: '#800080', level: 5, impactLevel: 10, name: 'ã€ç‰¹åˆ¥è­¦å ±ã€‘' };
        if (title.includes('åœŸç ‚ç½å®³è­¦æˆ’æƒ…å ±')) return { color: '#FF00FF', level: 4, impactLevel: 8, name: 'ã€åœŸç ‚ç½å®³è­¦æˆ’ã€‘' };
        if (title.includes('è­¦å ±')) return { color: '#FF0000', level: 3, impactLevel: 6, name: 'ã€è­¦å ±ã€‘' };
        if (title.includes('æ³¨æ„å ±')) return { color: '#FFFF00', level: 2, impactLevel: 4, name: 'ã€æ³¨æ„å ±ã€‘' };
        return { color: '#888888', level: 1, impactLevel: 2, name: 'æ—©æœŸæ³¨æ„æƒ…å ±' };
    }

    function placeWarningMarkers(warnings) {
        if (!warnings || warnings.length === 0) { checkStoreImpacts(); return; }
        warnings.forEach(function(w) {
            var lat = parseFloat(w.lat), lng = parseFloat(w.lng); if (isNaN(lat) || isNaN(lng)) return;
            var style = getWarningStyle(w.title);
            var circle = new google.maps.Circle({ map: map, center: { lat: lat, lng: lng }, radius: 20000, fillColor: style.color, fillOpacity: 0.25, strokeColor: style.color, strokeOpacity: 0.5, strokeWeight: 1 });
            circle.warningStyle = style;
            allWarningCircles.push(circle);
            
            var infoContent = 
                '<strong style="color:' + style.color + ';">' + escapeHtml(w.title) + '</strong><br>' +
                '<strong>åœ°åŸŸ:</strong> ' + escapeHtml(w.region) + '<br>' +
                '<strong>å†…å®¹:</strong> ' + escapeHtml(w.summary) + '<br>' +
                '<a href="' + escapeHtml(w.link) + '" target="_blank">è©³ç´°(æ°—è±¡åº)</a><br>' +
                '<strong>ç™ºè¡¨:</strong> ' + new Date(w.time).toLocaleString();

            circle.addListener('click', function() {
                infoWindow.setContent(infoContent);
                infoWindow.setPosition({ lat: lat, lng: lng });
                infoWindow.open(map);
            });
        });
        toggleLayerVisibility(allWarningCircles, document.getElementById('toggleWarnings').checked);
        checkStoreImpacts();
    }

    /**
     * ã€æ–°è¦ä½œæˆã€‘éƒ½é“åºœçœŒã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
     * @param {Array<string>} prefectures - è‰²ã‚’å¡—ã‚‹éƒ½é“åºœçœŒåã®ãƒªã‚¹ãƒˆ
     * @param {Array<Object>} warnings - è‰²ã‚’æ±ºã‚ã‚‹ãŸã‚ã®è­¦å ±ãƒ‡ãƒ¼ã‚¿
     */
    function updatePrefectureHighlight(prefectures, warnings) {
        // ã¾ãšã™ã¹ã¦ã®éƒ½é“åºœçœŒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        map.data.forEach(feature => {
            map.data.revertStyle(feature);
        });

        if (!prefectures || prefectures.length === 0) return;

        map.data.forEach(feature => {
            const prefName = feature.getProperty('name_ja');
            if (prefectures.includes(prefName)) {
                // ã“ã®éƒ½é“åºœçœŒã«å‡ºã¦ã„ã‚‹æœ€ã‚‚é«˜ã„ãƒ¬ãƒ™ãƒ«ã®è­¦å ±ã‚’æ¢ã™
                const maxLevelWarning = warnings
                    .filter(w => w.region.startsWith(prefName))
                    .reduce((max, w) => {
                        const style = getWarningStyle(w.title);
                        return style.level > max.level ? style : max;
                    }, { level: 0, color: '#333333' }); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
                
                // åœ°å›³ã®ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã
                map.data.overrideStyle(feature, {
                    fillColor: maxLevelWarning.color,
                    fillOpacity: 0.4,
                    strokeColor: '#333', // å¢ƒç•Œç·šã®è‰²ã¯æ¿ƒã„ã‚°ãƒ¬ãƒ¼ã§çµ±ä¸€
                    strokeWeight: 2,
                    zIndex: 2 // ä»–ã®ãƒãƒªã‚´ãƒ³ã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º
                });
            }
        });
    }


    function placeMerakiOutageMarkers(outages) {
        if (!outages || outages.length === 0) return;
        var iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><defs><filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="12" cy="12" r="10" fill="#212121"/><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="#D32F2F" stroke="#F44336" stroke-width="0.5" style="filter:url(#glow)"/></svg>';
        outages.forEach(function(o) {
            var lat = parseFloat(o.lat), lng = parseFloat(o.lng); if (isNaN(lat) || isNaN(lng)) return;
            var markerContent = document.createElement('div'); markerContent.innerHTML = iconSvg; markerContent.style.cursor = 'pointer';
            var marker = new google.maps.marker.AdvancedMarkerElement({ map: map, position: { lat: lat, lng: lng }, content: markerContent, title: o.storeName + ' (ã‚¹ã‚¤ãƒƒãƒDOWN)' });
            allOutageMarkers.push(marker);
            marker.addListener('gmp-click', function() {
                var content = `<div style="font-family: sans-serif; font-size: 14px; max-width: 280px;"><strong style="font-size: 16px; color: #D32F2F;">ğŸš¨ Merakiã‚¹ã‚¤ãƒƒãƒDOWN (åœé›»ã®å¯èƒ½æ€§)</strong><br><strong>åº—èˆ—å:</strong> ${escapeHtml(o.storeName)}<br><strong>ä½æ‰€:</strong> ${escapeHtml(o.address)}<br><strong>æœ€çµ‚ç¢ºèªæ™‚åˆ»:</strong> ${(o.lastSeen ? new Date(o.lastSeen).toLocaleString() : 'ä¸æ˜')}<br><small style="color: #757575;">ã“ã®æƒ…å ±ã¯Merakiãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿå™¨ã®ç–é€šæ–­ã‚’æ¤œçŸ¥ã—ãŸã‚‚ã®ã§ã™ã€‚</small></div>`;
                infoWindow.setContent(content); infoWindow.open({ anchor: marker, map: map });
            });
        });
        toggleLayerVisibility(allOutageMarkers, document.getElementById('toggleOutages').checked);
    }
    
    function convertIntensityToString(intensity) {
        if (intensity >= 7.0) return '7'; if (intensity >= 6.5) return '6å¼·'; if (intensity >= 6.0) return '6å¼±';
        if (intensity >= 5.5) return '5å¼·'; if (intensity >= 5.0) return '5å¼±'; if (intensity >= 4.0) return '4';
        if (intensity >= 3.0) return '3'; if (intensity >= 2.0) return '2'; if (intensity >= 1.0) return '1'; return 'ä¸æ˜';
    }

    function getEarthquakeStyle(intensity) {
        const intensityString = convertIntensityToString(intensity); const name = `éœ‡åº¦ ${intensityString}`;
        if (intensity >= 7.0) return { color: '#800080', textColor: '#FFFFFF', scale: 25, impactLevel: 11, name: name };
        if (intensity >= 6.5) return { color: '#d9333f', textColor: '#FFFFFF', scale: 22, impactLevel: 9, name: name };
        if (intensity >= 6.0) return { color: '#ff4500', textColor: '#FFFFFF', scale: 20, impactLevel: 9, name: name };
        if (intensity >= 5.5) return { color: '#ff8c00', textColor: '#FFFFFF', scale: 18, impactLevel: 7, name: name };
        if (intensity >= 5.0) return { color: '#ffc400', textColor: '#000000', scale: 15, impactLevel: 7, name: name };
        if (intensity >= 4.0) return { color: '#00bfff', textColor: '#FFFFFF', scale: 10, impactLevel: 5, name: name };
        if (intensity >= 3.0) return { color: '#90ee90', textColor: '#000000', scale: 8,  impactLevel: 3, name: name };
        return { color: '#d3d3d3', textColor: '#000000', scale: 5, impactLevel: 1, name: name };
    }

    function createEarthquakeMarkerContent(intensity) {
        const style = getEarthquakeStyle(intensity); const intensityText = convertIntensityToString(intensity);
        const container = document.createElement('div'); container.style.position = 'relative'; container.style.width = '40px'; container.style.height = '40px';
        const rippleEl = document.createElement('div');
        rippleEl.style.cssText = `position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border-radius: 50%; background-color: ${style.color}; transform: translate(-50%, -50%); animation: ripple 1.5s infinite ease-out;`;
        const markerEl = document.createElement('div');
        markerEl.style.cssText = `position: absolute; top: 50%; left: 50%; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background-color: ${style.color}; color: ${style.textColor}; font-size: 14px; font-weight: bold; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.5); cursor: pointer; transform: translate(-50%, -50%);`;
        markerEl.textContent = intensityText;
        container.appendChild(rippleEl); container.appendChild(markerEl);
        if (!document.getElementById('earthquake-ripple-style')) {
            const styleSheet = document.createElement("style"); styleSheet.id = 'earthquake-ripple-style'; styleSheet.type = "text/css";
            styleSheet.innerText = `@keyframes ripple { 0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }`;
            document.head.appendChild(styleSheet);
        }
        return container;
    }

    function placeEarthquakeMarkers(quakes) {
        if (!quakes || quakes.length === 0) return;
        quakes.forEach(q => {
            const lat = parseFloat(q.lat), lng = parseFloat(q.lng); if (isNaN(lat) || isNaN(lng)) return;
            const position = { lat, lng }; const intensity = parseFloat(q.maxIntensity); const style = getEarthquakeStyle(intensity);
            const circle = new google.maps.Circle({ strokeColor: style.color, strokeOpacity: 0.5, strokeWeight: 1, fillColor: style.color, fillOpacity: 0.2, map: map, center: position, radius: style.scale * 15000, zIndex: 99 });
            circle.quakeStyle = style; allEarthquakeCircles.push(circle);
            const marker = new google.maps.marker.AdvancedMarkerElement({ position, map, content: createEarthquakeMarkerContent(intensity), title: q.title, zIndex: 100 });
            allEarthquakeOverlays.push(circle, marker);
            const infoContent = '<strong>' + escapeHtml(q.title) + '</strong><br>' + 'æœ€å¤§éœ‡åº¦: ' + convertIntensityToString(intensity) + '<br>' + escapeHtml(q.content) + '<br>' + '<a href="' + escapeHtml(q.detailLink) + '" target="_blank">è©³ç´°æƒ…å ±</a>';
            marker.addListener('gmp-click', () => { infoWindow.setContent(infoContent); infoWindow.open({ anchor: marker, map: map }); });
            circle.addListener('click', () => { infoWindow.setContent(infoContent); infoWindow.setPosition(position); infoWindow.open(map); });
        });
        toggleLayerVisibility(allEarthquakeOverlays, document.getElementById('toggleEarthquakes').checked);
    }
        
    function placeLineShapedPrecipitationPolygons(polygons) {
      if (!polygons || polygons.length === 0) return;
      polygons.forEach(function(area) {
        var polygonPath = area.coordinates[0].map(function(coord) { return { lat: coord[1], lng: coord[0] }; });
        var lspPolygon = new google.maps.Polygon({ paths: polygonPath, strokeColor: "#FF00FF", strokeOpacity: 0.8, strokeWeight: 2, fillColor: "#FF00FF", fillOpacity: 0.35, map: map, zIndex: 90 });
        allLspPolygons.push(lspPolygon);
        lspPolygon.addListener('click', function(event) {
          var content = `<strong style="color:#FF00FF;">ã€è­¦æˆ’ãƒ¬ãƒ™ãƒ«4ç›¸å½“ã€‘ç·šçŠ¶é™æ°´å¸¯ç™ºç”Ÿæƒ…å ±</span></strong><br><strong>ã‚¨ãƒªã‚¢:</strong> ${escapeHtml(area.name)}<br><strong>ç™ºè¡¨æ™‚åˆ»:</strong> ${new Date(area.time).toLocaleString()}`;
          infoWindow.setContent(content); infoWindow.setPosition(event.latLng); infoWindow.open(map);
        });
      });
      toggleLayerVisibility(allLspPolygons, document.getElementById('toggleLsp').checked);
    }

    function loadWeatherWarnings(warnings) {
      var ul = document.getElementById('warningsList');
      if (!Array.isArray(warnings) || warnings.length === 0) { var li = document.createElement('li'); li.textContent = 'ç¾åœ¨ã€ç™ºè¡¨ã•ã‚Œã¦ã„ã‚‹è­¦å ±ãƒ»æ³¨æ„å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚'; ul.appendChild(li); return; }
      warnings.forEach(function(w) {
        var li = document.createElement('li'); li.style.marginBottom = '8px';
        var style = getWarningStyle(w.title);
        li.innerHTML = `<strong style="color:${style.color};">${escapeHtml(w.title)} (${(w.region||'åœ°åŸŸä¸æ˜')})</strong><br><small>${(w.time ? new Date(w.time).toLocaleString() : 'æ™‚åˆ»ä¸æ˜')}</small><br><small>${(w.summary||'è©³ç´°æƒ…å ±ãªã—')}</small>`;
        ul.appendChild(li);
      });
    }

    function placeMarkers() {
        return new Promise(function(resolve) {
            var locationMap = new Map();
            allRoutes.forEach(function(route) {
                if (!locationMap.has(route.origin)) locationMap.set(route.origin, { name: route.originName, type: "base" });
                if (route.waypoints) route.waypoints.forEach(function(w) { if (!locationMap.has(w.address)) locationMap.set(w.address, { name: w.name, type: "store" }); });
                if (!locationMap.has(route.destination)) locationMap.set(route.destination, { name: route.destinationName, type: "store" });
            });
            var geocodingPromises = Array.from(locationMap.entries()).map(function(entry) {
                return new Promise(function(pResolve) {
                    geocoder.geocode({ address: entry[0] }, function(results, status) {
                        if (status === 'OK' && results[0] && entry[1].type === 'store') {
                           allStoreMarkers.push({ marker: { position: results[0].geometry.location, content: null }, name: entry[1].name });
                        }
                        pResolve();
                    });
                });
            });
            Promise.all(geocodingPromises).then(resolve);
        });
    }
    
    // â˜…â˜…â˜… ä¿®æ­£ã•ã‚ŒãŸå½±éŸ¿åˆ¤å®šé–¢æ•° â˜…â˜…â˜…
function checkStoreImpacts() {
    const list = document.getElementById('affectedStoresList');
    list.innerHTML = '';
    let affectedStoresForList = [];
    const allCheckableStores = allStoreMarkers.concat(monogatariMarkers);
    const MIN_IMPACT_LEVEL_FOR_HIGHLIGHT = 6;

    allCheckableStores.forEach(store => {
        if (!store || !store.marker || !store.marker.position) return;
        const impacts = [];
        allWarningCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { impacts.push({ type: 'warning', style: circle.warningStyle }); } });
        allEarthquakeCircles.forEach(circle => { if (circle.getMap() && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()) <= circle.getRadius()) { const distance = google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, circle.getCenter()); impacts.push({ type: 'quake', style: circle.quakeStyle, distance: distance, radius: circle.getRadius() }); } });
        const markerContent = store.marker.content;
        if (impacts.length > 0) {
            impacts.sort((a, b) => b.style.impactLevel - a.style.impactLevel);
            const highestImpact = impacts[0];
            if (highestImpact.style.impactLevel >= MIN_IMPACT_LEVEL_FOR_HIGHLIGHT) {
                let distance = (highestImpact.type === 'quake') ? highestImpact.distance : null;
                affectedStoresForList.push({ name: store.name, address: store.address || '', level: highestImpact.style.impactLevel, color: highestImpact.style.color, text: highestImpact.style.name, distance: distance, store: store });
                if (markerContent) {
                    let finalColor = highestImpact.style.color;
                    if (highestImpact.type === 'quake' && highestImpact.style.endColor) {
                        const factor = highestImpact.distance / highestImpact.radius;
                        const startRgb = hexToRgb(highestImpact.style.color);
                        const endRgb = hexToRgb(highestImpact.style.endColor);
                        finalColor = interpolateColor(startRgb, endRgb, factor);
                    }
                    if (markerContent.classList.contains('pin-marker-content')) {
                        const newLabel = document.createElement('div');
                        newLabel.className = 'warning-label';
                        newLabel.style.backgroundColor = finalColor;
                        newLabel.style.color = highestImpact.style.textColor || ((highestImpact.style.impactLevel < 5) ? '#000' : '#fff');
                        newLabel.textContent = store.name;
                        store.marker.content = newLabel;
                    } else if (markerContent.classList.contains('warning-label')) {
                        markerContent.style.backgroundColor = finalColor;
                    }
                }
            } else {
                if (markerContent && markerContent.classList.contains('warning-label')) {
                    store.marker.content = createPinMarkerContent();
                }
            }
        } else {
            if (markerContent && markerContent.classList.contains('warning-label')) {
                store.marker.content = createPinMarkerContent();
            }
        }
    });

    affectedStoresForList.sort((a, b) => b.level - a.level);
    if (affectedStoresForList.length === 0) {
        list.innerHTML = '<li>ç¾åœ¨ã€è­¦æˆ’ãƒ¬ãƒ™ãƒ«3ä»¥ä¸Šã®å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹åº—èˆ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
    } else {
        affectedStoresForList.forEach(item => {
            const li = document.createElement('li');
            li.style.cssText = 'padding: 8px; cursor: default; border-left: 4px solid ' + item.color + '; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;';
            let xSearchButton = '';
            if (item.address) {
                const addressParts = item.address.match(/(([^éƒ½]*)éƒ½)?(([^åºœ]*)åºœ)?(([^çœŒ]*)çœŒ)?([^å¸‚]*)å¸‚([^åŒº]*)åŒº?(.*)/);
                let searchQuery = "";
                if(addressParts) {
                    const city = addressParts[7] ? addressParts[7] + "å¸‚" : "";
                    const ward = addressParts[9] ? addressParts[9] + "åŒº" : "";
                    searchQuery = ward || city;
                }
                if (searchQuery) {
                    const xQuery = encodeURIComponent(searchQuery + ' (åœé›» OR æ–­æ°´ OR å† æ°´ OR é¿é›£ OR ç½å®³ OR é‹è»¢è¦‹åˆã‚ã›)');
                    const xSearchUrl = 'https://twitter.com/search?q=' + xQuery + '&f=live';
                    xSearchButton = '<a href="' + xSearchUrl + '" target="_blank" style="margin-left: 10px; padding: 4px 8px; background-color: #000; color: #fff; text-decoration: none; border-radius: 12px; font-size: 10px; font-weight:bold;">X</a>';
                }
            }
            const distanceText = item.distance !== null ? ' (éœ‡æºã‹ã‚‰ç´„' + (item.distance / 1000).toFixed(1) + 'km)' : '';
            
            li.innerHTML = 
                '<div style="flex-grow: 1; cursor: pointer;" onclick="map.setCenter({lat:' + item.store.marker.position.lat + ',lng:' + item.store.marker.position.lng + '}); map.setZoom(14);">' +
                    '<span style="color:' + item.color + '; font-weight: bold;">[' + escapeHtml(item.text) + ']</span> ' +
                    '<span>' + escapeHtml(item.name) + distanceText + '</span>' +
                '</div>' +
                xSearchButton;
                
            list.appendChild(li);
        });
    }
}
    /*
    function checkStoreImpacts() {
        var list = document.getElementById('affectedStoresList'); list.innerHTML = '';
        var affectedStoresForList = [];
        var allCheckableStores = allStoreMarkers.concat(monogatariMarkers);

        allCheckableStores.forEach(function(store) {
            if (!store || !store.marker || !store.marker.position) return;
            
            const affectingWarningCircles = allWarningCircles.filter(c => c.getMap() != null && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, c.getCenter()) <= c.getRadius());
            const affectingQuakeCircles = allEarthquakeCircles.filter(c => c.getMap() != null && google.maps.geometry.spherical.computeDistanceBetween(store.marker.position, c.getCenter()) <= c.getRadius());
            const allAffectingCircles = [].concat(affectingWarningCircles, affectingQuakeCircles);
            
            var markerContent = store.marker.content;
            
            if (allAffectingCircles.length > 0) {
                let highestImpactStyle = null;
                let maxImpactLevel = -1;

                allAffectingCircles.forEach(circle => {
                    const style = circle.warningStyle || circle.quakeStyle;
                    if (style && style.impactLevel > maxImpactLevel) {
                        maxImpactLevel = style.impactLevel;
                        highestImpactStyle = style;
                    }
                });

                if (highestImpactStyle) {
                    affectedStoresForList.push({ name: store.name, level: maxImpactLevel, color: highestImpactStyle.color, text: highestImpactStyle.name, store: store });
                    
                    // ãƒãƒ¼ã‚«ãƒ¼ã®è¦‹ãŸç›®ã®å¤‰æ›´ã¯ã€contentãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆï¼è¡¨ç¤ºä¸­ã®ãƒãƒ¼ã‚«ãƒ¼ï¼‰ã®ã¿è¡Œã†
                    if (markerContent && markerContent.classList.contains('pin-marker-content')) {
                        var newLabel = document.createElement('div');
                        newLabel.className = 'warning-label';
                        newLabel.style.backgroundColor = highestImpactStyle.color;
                        const textColor = highestImpactStyle.textColor || ((highestImpactStyle.level === 2) ? '#000' : '#fff');
                        newLabel.style.color = textColor;
                        newLabel.textContent = store.name;
                        store.marker.content = newLabel;
                    }
                }
            } else {
                // å½±éŸ¿ãŒãªããªã£ãŸå ´åˆã€contentãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å…ƒã®ãƒãƒ¼ã‚«ãƒ¼ã«æˆ»ã™
                if (markerContent && markerContent.classList.contains('warning-label')) {
                    store.marker.content = createPinMarkerContent();
                }
            }
        });

        affectedStoresForList.sort((a, b) => b.level - a.level);
        if (affectedStoresForList.length === 0) {
            list.innerHTML = '<li>ç¾åœ¨ã€å½±éŸ¿ã‚’å—ã‘ã¦ã„ã‚‹åº—èˆ—ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
        } else {
            affectedStoresForList.forEach(function(item) {
                var li = document.createElement('li');
                li.style.cssText = 'padding: 4px 0; cursor: pointer; border-left: 4px solid ' + item.color + '; padding-left: 8px; margin-bottom: 4px;';
                li.innerHTML = `<span style="color:${item.color}; font-weight: bold;">${escapeHtml(item.text)}</span> ${escapeHtml(item.name)}`;
                li.onmouseover = function() { this.style.backgroundColor = '#f5f5f5'; };
                li.onmouseout = function() { this.style.backgroundColor = 'transparent'; };
                li.onclick = function() { map.setCenter(item.store.marker.position); map.setZoom(14); };
                list.appendChild(li);
            });
        }
    }*/


    function populateFilters(data) {
      if(!data) return;
      var originSet = new Set(), destSet = new Set();
      data.forEach(r => { originSet.add(r.originName); destSet.add(r.destinationName); });
      var originSelect = document.getElementById('originSelect'); originSelect.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
      originSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; originSelect.appendChild(o); });
      var destSelect = document.getElementById('destinationSelect'); destSelect.innerHTML = '<option value="all">ã™ã¹ã¦</option>';
      destSet.forEach(name => { var o = document.createElement('option'); o.value = name; o.textContent = name; destSelect.appendChild(o); });
    }
    function drawFilteredRoutes() {
        if(!allRoutes) return;
        
        // æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
        renderedRoutes.forEach(r => r.setMap(null));
        renderedRoutes = [];
        animationIntervals.forEach(clearInterval);
        animationIntervals = [];

        // â˜…â˜…â˜… 3. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¾®ä¿®æ­£ â˜…â˜…â˜…
        // ï¼ˆç¾çŠ¶ã®ã¾ã¾ã§ã‚‚ "ã™ã¹ã¦" ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã®ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚ˆã‚Šæ˜ç¢ºã«ã—ã¾ã™ï¼‰
        var originFilter = document.getElementById('originSelect').value;
        var destFilter = document.getElementById('destinationSelect').value;
        
        // ã“ã®é–¢æ•°ãŒå‘¼ã°ã‚ŒãŸæ™‚ç‚¹ã§ã¯ã€å¸¸ã«å…¨ãƒ«ãƒ¼ãƒˆã‚’æç”»å¯¾è±¡ã¨ã™ã‚‹
        // (å°†æ¥çš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å¾©æ´»ã•ã›ã‚‹ã“ã¨ã‚‚å¯èƒ½)
        var filtered = allRoutes; 

        let delay = 0;
        filtered.forEach(route => {
            setTimeout(() => {
                var waypointsForRequest = (route.waypoints || []).map(w => ({ location: w.address, stopover: true }));
                directionsService.route({ 
                    origin: route.origin, 
                    destination: route.destination, 
                    waypoints: waypointsForRequest, 
                    travelMode: 'DRIVING', 
                    drivingOptions: { departureTime: new Date(), trafficModel: 'bestguess' }
                }, (result, status) => { 
                    if (status === 'OK') {
                        drawAnimatedRoute(result, route); 
                    } else {
                        console.error('ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—:', status, 'å¯¾è±¡:', route.originName + ' -> ' + route.destinationName); 
                    }
                });
            }, delay);
            delay += 100; // APIè² è·è»½æ¸›ã®ãŸã‚ã®é…å»¶
        }); 
    }
    function drawAnimatedRoute(directionsResult, routeInfo) {
        var route = directionsResult.routes[0], totalDistance = 0, totalDuration = 0;
        route.legs.forEach(leg => { totalDistance += leg.distance.value; totalDuration += (leg.duration_in_traffic ? leg.duration_in_traffic.value : leg.duration.value); });
        var waypointsDisplay = routeInfo.waypoints && routeInfo.waypoints.length > 0 ? '<strong>çµŒç”±åœ°:</strong> ' + routeInfo.waypoints.map(wp => escapeHtml(wp.name)).join(' â†’ ') + '<br>' : '';
        
        var tooltipContent = 
            '<div style="font-family: sans-serif; font-size: 14px; max-width: 300px; line-height: 1.6;">' +
            '<strong style="font-size: 16px; color: #007bff;">ãƒ«ãƒ¼ãƒˆè©³ç´°</strong><hr style="margin: 4px 0;">' +
            '<strong>å‡ºç™ºåœ°:</strong> ' + escapeHtml(routeInfo.originName) + '<br>' +
            waypointsDisplay +
            '<strong>ç›®çš„åœ°:</strong> ' + escapeHtml(routeInfo.destinationName) + '<hr style="margin: 4px 0;">' +
            '<strong>ç·è·é›¢:</strong> ' + (totalDistance / 1000).toFixed(1) + ' km<br>' +
            '<strong>äºˆæ¸¬æ‰€è¦æ™‚é–“:</strong> ' + Math.round(totalDuration / 60) + ' åˆ†</div>';

        var basePolyline = new google.maps.Polyline({ path: route.overview_path, strokeColor: '#0099ff', strokeOpacity: 0.3, strokeWeight: 8, map: map });
        var animatedPolyline = new google.maps.Polyline({ path: route.overview_path, strokeOpacity: 0, icons: [{ icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW, scale: 3, fillColor: '#FF0000', fillOpacity: 0.8, strokeWeight: 1 }, offset: '0%' }], map: map });
        basePolyline.addListener('click', e => { infoWindow.setContent(tooltipContent); infoWindow.setPosition(e.latLng); infoWindow.open(map); });
        basePolyline.addListener('mouseover', () => { map.getDiv().style.cursor = 'pointer'; });
        basePolyline.addListener('mouseout', () => { map.getDiv().style.cursor = ''; });
        renderedRoutes.push(basePolyline, animatedPolyline);
        var count = 0;
        var interval = setInterval(() => { count = (count + 1) % 200; var icons = animatedPolyline.get('icons'); icons[0].offset = (count / 2) + '%'; animatedPolyline.set('icons', icons); }, 50);
        animationIntervals.push(interval);
    }

    google.script.run.withSuccessHandler(function(apiKey) {
      var script = document.createElement('script');
      script.src = 'https://maps.googleapis.com/maps/api/js?key=' + apiKey + '&libraries=marker,geometry,places&callback=initMap';
      script.async = true;
      document.head.appendChild(script);
    }).getApiKey();
</script>