<script>
    // グローバル変数
    var map, directionsService, infoWindow, geocoder;
    var allRoutes = [], renderedRoutes = [], animationIntervals = [], allStoreMarkers = [];
    var allWarningCircles = [], allEarthquakeCircles = [], allEarthquakeOverlays = [], allLspPolygons = [], allOutageMarkers = [], monogatariMarkers = [];
    var allTyphoonOverlays = [];
    var earthquakeAnimationIntervals = [];
    var radarUpdateInterval = null;
    var trafficLayer;

    // --- ユーティリティ関数 ---
    function escapeHtml(str) { if (typeof str !== 'string' || !str) return ''; return str.replace(/[&<>"']/g, function(match) { return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#039;'}[match]; }); }
    function togglePanel(header) { var content = header.nextElementSibling; var text = header.innerHTML; if (content.style.maxHeight && content.style.maxHeight !== '0px') { content.style.maxHeight = '0px'; header.innerHTML = text.replace('▴', '▾'); } else { content.style.maxHeight = content.scrollHeight + "px"; header.innerHTML = text.replace('▾', '▴'); } }
    function interpolateColor(color1, color2, factor) { factor = Math.max(0, Math.min(1, factor)); const result = color1.slice(); for (let i = 0; i < 3; i++) { result[i] = Math.round(result[i] + factor * (color2[i] - result[i])); } return `rgb(${result[0]}, ${result[1]}, ${result[2]})`; }
    function hexToRgb(hex) { if(!hex || hex.length < 4) return [0,0,0]; const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return [r, g, b];}

    // --- 自動更新ロジック ---
    function clearAllOverlays() {
        renderedRoutes.forEach(r => r.setMap(null)); renderedRoutes = [];
        animationIntervals.forEach(clearInterval); animationIntervals = [];
        allWarningCircles.forEach(c => c.setMap(null)); allWarningCircles = [];
        allEarthquakeCircles.forEach(c => c.setMap(null)); allEarthquakeCircles = [];
        allEarthquakeOverlays.forEach(o => o.setMap(null)); allEarthquakeOverlays = [];
        allTyphoonOverlays.forEach(o => o.setMap(null)); allTyphoonOverlays = [];
        earthquakeAnimationIntervals.forEach(clearInterval); earthquakeAnimationIntervals = [];
        allLspPolygons.forEach(p => p.setMap(null)); allLspPolygons = [];
        allOutageMarkers.forEach(m => m.setMap(null)); allOutageMarkers = [];
        monogatariMarkers.forEach(m => m.marker.setMap(null)); monogatariMarkers = [];
        allStoreMarkers = [];
        document.getElementById('warningsList').innerHTML = '';
        document.getElementById('affectedStoresList').innerHTML = '<li>情報を更新しています...</li>';
    }

    async function refreshAllData() {
        console.log(`[${new Date().toLocaleTimeString()}] データの更新を開始します...`);
        const loader = document.getElementById('loader-overlay');
        loader.classList.remove('hidden');
        clearAllOverlays();
        
        const [routes, warnings, quakes, outages, lspData, monogatariStores] = await Promise.all([
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getRouteMapData()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getWeatherWarningsFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getEarthquakeDataFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getPowerOutageDataFromMeraki()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getLineShapedPrecipitationFromSheet()),
            new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMonogatariStores())
        ]);
        
        await fetchTyphoonData();

        console.log("基本データの取得が完了しました。");
        allRoutes = routes;
        populateFilters(routes);
        await placeMarkers();
        drawFilteredRoutes();
        placeMonogatariMarkers(monogatariStores);
        loadWeatherWarnings(warnings);
        placeEarthquakeMarkers(quakes);
        placeMerakiOutageMarkers(outages);
        if(lspData) {
            placeLineShapedPrecipitationPolygons(lspData.polygons);
            addLspTextToWarnings(lspData.texts);
        }
        placeWarningMarkers(warnings);
        document.getElementById('last-updated').textContent = '最終更新: ' + new Date().toLocaleTimeString();
        console.log(`[${new Date().toLocaleTimeString()}] データの更新が完了しました。`);
        loader.classList.add('hidden');
    }

    // --- 初期化処理 ---
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center: { lat: 36.2048, lng: 138.2529 }, zoom: 6, mapId: 'd9bbe126f7dc436f2b40c092' });
      trafficLayer = new google.maps.TrafficLayer(); trafficLayer.setMap(map);
      directionsService = new google.maps.DirectionsService();
      infoWindow = new google.maps.InfoWindow();
      geocoder = new google.maps.Geocoder();
      setupLayerToggles();
      setupRadarControls();
      await refreshAllData();
      setInterval(refreshAllData, 5 * 60 * 1000);
    }

    // --- イベントリスナー設定 ---
    function setupLayerToggles() {
      document.getElementById('originSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('destinationSelect').addEventListener('change', drawFilteredRoutes);
      document.getElementById('toggleTraffic').addEventListener('change', (e) => trafficLayer.setMap(e.target.checked ? map : null));
      document.getElementById('toggleWarnings').addEventListener('change', (e) => { toggleLayerVisibility(allWarningCircles, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleEarthquakes').addEventListener('change', (e) => { toggleLayerVisibility(allEarthquakeOverlays, e.target.checked); checkStoreImpacts(); });
      document.getElementById('toggleTyphoons').addEventListener('change', (e) => toggleLayerVisibility(allTyphoonOverlays, e.target.checked));
      document.getElementById('toggleLsp').addEventListener('change', (e) => toggleLayerVisibility(allLspPolygons, e.target.checked));
      document.getElementById('toggleOutages').addEventListener('change', (e) => toggleLayerVisibility(allOutageMarkers, e.target.checked));
      document.getElementById('toggleMonogatariStores').addEventListener('change', (e) => toggleLayerVisibility(monogatariMarkers.map(m => m.marker), e.target.checked));
    }

    // --- 表示レイヤー関連の関数 ---
    function toggleLayerVisibility(overlays, isVisible) { overlays.forEach(overlay => { if(overlay) overlay.setMap(isVisible ? map : null); }); }

    function setupRadarControls() {
        var toggle = document.getElementById('toggleRadar');
        var slider = document.getElementById('radarOpacitySlider');
        var currentRadarLayer = null;
        function removeCurrentRadarLayer() { if (currentRadarLayer) { map.overlayMapTypes.removeAt(map.overlayMapTypes.getArray().indexOf(currentRadarLayer)); currentRadarLayer = null; } }
        function updateRadar() {
            var date = new Date(); var minutes = date.getMinutes();
            var roundedMinutes = Math.floor(minutes / 5) * 5;
            date.setMinutes(roundedMinutes, 0, 0);
            var year = date.getUTCFullYear(), month = ('0' + (date.getUTCMonth() + 1)).slice(-2), day = ('0' + date.getUTCDate()).slice(-2), hours = ('0' + date.getUTCHours()).slice(-2), mins = ('0' + date.getUTCMinutes()).slice(-2);
            var timestamp = "" + year + month + day + hours + mins + "00";
            removeCurrentRadarLayer();
            var opacity = parseFloat(slider.value);
            currentRadarLayer = new google.maps.ImageMapType({ getTileUrl: (c, z) => { if (z < 3 || z > 11) return null; return "https://www.jma.go.jp/bosai/jmatile/data/nowc/"+timestamp+"/none/"+timestamp+"/surf/hrpns/"+z+"/"+c.x+"/"+c.y+".png"; }, tileSize: new google.maps.Size(256, 256), isPng: true, name: "Rain Radar", opacity: opacity, minZoom: 3, maxZoom: 11 });
            map.overlayMapTypes.push(currentRadarLayer);
        }
        toggle.addEventListener('change', function() {
            if (this.checked) {
                slider.style.display = 'inline-block'; updateRadar();
                if (!radarUpdateInterval) { radarUpdateInterval = setInterval(updateRadar, 5 * 60 * 1000); }
            } else {
                slider.style.display = 'none'; removeCurrentRadarLayer();
                if (radarUpdateInterval) { clearInterval(radarUpdateInterval); radarUpdateInterval = null; }
            }
        });
        slider.addEventListener('input', () => { if (currentRadarLayer) currentRadarLayer.setOpacity(parseFloat(slider.value)); });
    }

    function createPinMarkerContent() {
        var markerContent = document.createElement('div');
        markerContent.style.cursor = 'pointer'; markerContent.className = 'pin-marker-content';
        var pinContainer = document.createElement('div'); pinContainer.style.cssText = 'position: relative; width: 28px; height: 40px; transform: translate(-50%, -100%);';
        var pinBody = document.createElement('div'); pinBody.style.cssText = 'position: absolute; left: 0; top: 0; width: 28px; height: 28px; border-radius: 50% 50% 50% 0; background: #EA4335; transform: rotate(-45deg); border: 1px solid #C62828;';
        pinContainer.appendChild(pinBody);
        var pinHead = document.createElement('div'); pinHead.style.cssText = 'position: absolute; left: 7px; top: 7px; width: 14px; height: 14px; border-radius: 50%; background: white;';
        pinContainer.appendChild(pinHead);
        markerContent.appendChild(pinContainer);
        return markerContent;
    }

    // ★★★ 修正後の placeMonogatariMarkers 関数 （緯度経度キャッシュ対応版） ★★★
    function placeMonogatariMarkers(stores) {
        if (!stores || stores.length === 0) { console.log("店舗データがありません。"); return; }
        monogatariMarkers.forEach(m => m.marker.setMap(null));
        monogatariMarkers = [];
        stores.forEach(store => {
            const lat = parseFloat(store.lat);
            const lng = parseFloat(store.lng);
            if (!isNaN(lat) && !isNaN(lng)) {
                const position = { lat: lat, lng: lng };
                var marker = new google.maps.marker.AdvancedMarkerElement({ map: map, position: position, content: createPinMarkerContent(), title: store.name });
                monogatariMarkers.push({ marker: marker, name: store.name, address: store.address });
                marker.addListener("gmp-click", () => {
                    var content = `<div style="font-family: sans-serif; font-size: 14px; max-width: 280px;"><strong style="font-size: 16px;">${escapeHtml(store.name)}</strong><br><strong>住所:</strong> ${escapeHtml(store.address)}<br><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.address)}" target="_blank">Googleマップで見る</a></div>`;
                    infoWindow.setContent(content);
                    infoWindow.open({ anchor: marker, map: map });
                });
            } else { console.warn(`無効な座標の店舗データ: ${store.name}`); }
        });
        const initialVisibility = document.getElementById('toggleMonogatariStores').checked;
        const markers = monogatariMarkers.map(m => m.marker);
        toggleLayerVisibility(markers, initialVisibility);
    }
    
    // --- この後の関数は、前回の回答と同じものを配置してください ---
    // (getWarningStyle, placeWarningMarkers, convertIntensityToString, getEarthquakeStyle, etc...)
    // placeTyphoonForecast, generateIsewanTyphoonDummyData なども全てここに含める

</script>



</script>
